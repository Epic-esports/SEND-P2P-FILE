<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P2P File Transfer</title>
<style>
body { margin:0; padding:0; font-family:Arial,sans-serif; background:#0f1115; color:white; display:flex; justify-content:center; align-items:center; height:100vh; }
.container { width:90%; max-width:400px; padding:20px; background:#1a1d24; border-radius:20px; text-align:center; box-shadow:0 0 25px rgba(0,0,0,0.4);}
h2{margin-bottom:20px;}
.btn { width:100%; background:#0099ff; border:none; padding:15px; border-radius:12px; font-size:18px; cursor:pointer; margin-top:15px;}
.btn:hover { background:#0077cc;}
.qr-box { margin-top:20px; padding:20px; background:#13161a; border-radius:12px; display:none; }
#qrCode { margin-top:15px; }
#fileInput { margin-top:15px; display:none;}
#reader { width:300px; margin-top:10px; border:2px solid #333; border-radius:12px; display:none;}
#status { margin-top:10px; }
</style>
</head>
<body>

<div class="container">
<h2>ðŸ“‚ P2P File Transfer</h2>

<button class="btn" onclick="selectMode('receive')">ðŸ“¥ Receive File</button>
<button class="btn" onclick="selectMode('send')">ðŸ“¤ Send File</button>

<div class="qr-box" id="qrBox">
    <p>Scan this QR code from your phone</p>
    <canvas id="qrCode"></canvas>
</div>

<div id="reader"></div>
<div id="status"></div>
<input type="file" id="fileInput">

</div>

<!-- QR + WebRTC libraries -->
<script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

<script>
let pc, dataChannel, ws;
let receiveBuffer=[], receivedSize=0, expectedSize=0;
let sessionId="", mode="";

// ---- SELECT MODE ----
function selectMode(m){
    mode=m;
    if(mode==='receive') startReceive();
    else startSendMode();
}

// ---- RECEIVE MODE (PC) ----
function startReceive(){
    document.getElementById("qrBox").style.display="block";
    sessionId = Math.random().toString(36).substring(2,10);
    new QRious({element:document.getElementById("qrCode"), value:sessionId, size:200});
    document.getElementById("status").innerText="Session ID: "+sessionId;

    pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    pc.onicecandidate = e=>{ if(e.candidate) sendSignal({type:'ice', candidate:e.candidate}); };
    pc.ondatachannel = e=>{
        dataChannel=e.channel;
        dataChannel.onmessage=handleReceive;
    };

    connectWS();
    ws.onopen = ()=> ws.send(JSON.stringify({type:'join', session:sessionId, role:'receiver'}));
}

// ---- SEND MODE (PHONE) ----
function startSendMode(){
    document.getElementById("reader").style.display="block";
    document.getElementById("status").innerText="Scan QR code from PC";

    pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    dataChannel = pc.createDataChannel("file-transfer");
    dataChannel.binaryType="arraybuffer";
    dataChannel.onopen = ()=>console.log("Data channel open");
    dataChannel.onclose = ()=>console.log("Data channel closed");

    pc.onicecandidate = e=>{ if(e.candidate) ws.send(JSON.stringify({type:'ice', session:sessionId, candidate:e.candidate})); };

    ws = new WebSocket("wss://p2p-munj.onrender.com");

    ws.onmessage = async e=>{
        const msg=JSON.parse(e.data);
        if(msg.type==='answer') await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
        if(msg.type==='ice' && msg.candidate) pc.addIceCandidate(msg.candidate);
    };

    const html5QrcodeScanner = new Html5Qrcode("reader");
    html5QrcodeScanner.start({facingMode:"environment"},{fps:10,qrbox:250}, onScanSuccess);

    function onScanSuccess(decodedText){
        sessionId=decodedText;
        document.getElementById("status").innerText="Scanned session: "+sessionId;
        ws.onopen = ()=> ws.send(JSON.stringify({type:'join', session:sessionId, role:'sender'}));
        createOffer();
        html5QrcodeScanner.clear();
        document.getElementById("fileInput").style.display="block";
    }
}

// ---- SIGNALING ----
function connectWS(){
    ws = new WebSocket("wss://p2p-munj.onrender.com");
    ws.onmessage = async e=>{
        const msg=JSON.parse(e.data);
        if(msg.type==='offer'){
            await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
            const answer=await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({type:'answer', session:sessionId, answer:pc.localDescription}));
        }
        if(msg.type==='ice' && msg.candidate) pc.addIceCandidate(msg.candidate);
    };
}

function sendSignal(msg){ if(ws&&ws.readyState===1) ws.send(JSON.stringify(msg)); }

// ---- CREATE OFFER (SEND) ----
async function createOffer(){
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    sendSignal({type:'offer', session:sessionId, offer:pc.localDescription});
}

// ---- FILE TRANSFER ----
document.getElementById("fileInput").addEventListener("change", e=>{
    const file=e.target.files[0];
    if(!file || !dataChannel || dataChannel.readyState!=="open") return;
    dataChannel.send(JSON.stringify({type:"meta", name:file.name, size:file.size}));

    const chunkSize = 16*1024;
    let offset=0;
    const reader = new FileReader();

    reader.onload=e=>{
        dataChannel.send(e.target.result);
        offset+=e.target.result.byteLength;
        if(offset<file.size) readSlice(offset);
        else dataChannel.send(JSON.stringify({type:"done", name:file.name}));
    }

    function readSlice(o){ reader.readAsArrayBuffer(file.slice(o,o+chunkSize)); }
    readSlice(0);
});

// ---- RECEIVE HANDLER ----
function handleReceive(event){
    if(typeof event.data==='string'){
        const msg=JSON.parse(event.data);
        if(msg.type==="meta"){ expectedSize=msg.size; receiveBuffer=[]; receivedSize=0; document.getElementById("status").innerText="Receiving "+msg.name; }
        if(msg.type==="done"){ const received=new Blob(receiveBuffer); const url=URL.createObjectURL(received); const a=document.createElement("a"); a.href=url; a.download=msg.name||"file.bin"; a.click(); document.getElementById("status").innerText="File received: "+msg.name; }
        return;
    }
    receiveBuffer.push(event.data);
    receivedSize+=event.data.byteLength;
    document.getElementById("status").innerText="Receiving: "+Math.floor(receivedSize/expectedSize*100)+"%";
}
</script>

</body>
</html>
